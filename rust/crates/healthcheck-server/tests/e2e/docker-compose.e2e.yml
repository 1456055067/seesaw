services:
  healthcheck-server:
    build:
      context: ../../../..
      dockerfile: crates/healthcheck-server/Dockerfile
    container_name: e2e-healthcheck-server
    volumes:
      - socket-vol:/var/run/seesaw
      - ./healthcheck-server.e2e.yaml:/app/healthcheck-server.yaml:ro
    networks:
      - e2e-net
    healthcheck:
      test: ["CMD-SHELL", "test -S /var/run/seesaw/healthcheck.sock"]
      interval: 1s
      timeout: 5s
      retries: 30
    depends_on:
      target-service:
        condition: service_healthy

  target-service:
    image: nginx:alpine
    container_name: e2e-target-service
    volumes:
      - ./nginx.conf:/etc/nginx/conf.d/default.conf:ro
    networks:
      - e2e-net
    entrypoint:
      - /bin/sh
      - -c
      - "echo OK > /usr/share/nginx/html/healthy.txt && nginx -g 'daemon off;'"
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://127.0.0.1/health || exit 1"]
      interval: 1s
      timeout: 3s
      retries: 10

  proxy-simulator:
    image: alpine:latest
    container_name: e2e-proxy-simulator
    volumes:
      - socket-vol:/var/run/seesaw
      - ./proxy-simulator.sh:/app/proxy-simulator.sh:ro
    networks:
      - e2e-net
    entrypoint:
      - /bin/sh
      - -c
      - "apk add --no-cache bash socat jq curl bind-tools > /dev/null 2>&1 && bash /app/proxy-simulator.sh"
    depends_on:
      healthcheck-server:
        condition: service_healthy

volumes:
  socket-vol:

networks:
  e2e-net:
    driver: bridge
